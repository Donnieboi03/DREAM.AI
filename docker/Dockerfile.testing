# Python image for DreamAI (ProcTHOR / AI2-THOR)
FROM python:3.12-slim

# System deps for AI2-THOR (Unity) + headless rendering
# Plus build deps for ProcTHOR's python-fcl (Cython/C++ extension)
RUN apt-get update && apt-get install -y --no-install-recommends \
    wget \    
    xvfb \
    xauth \
    procps \
    fluxbox \
    x11vnc \
    novnc \
    websockify \
    libgl1 \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender1 \
    libxi6 \
    libxrandr2 \
    libxss1 \
    libxtst6 \
    libnss3 \
    libasound2 \
    ca-certificates \
    git \
    build-essential \
    python3-dev \
    libeigen3-dev \
    libccd-dev \
    libfcl-dev \
  && rm -rf /var/lib/apt/lists/*

# Project lives at /src (repo root); src package at /src/src
WORKDIR /src
COPY . /src

# Install DreamAI dependencies
RUN pip install --no-cache-dir --upgrade pip \
 && pip install -r /src/src/requirements.txt \
 && pip install --no-cache-dir -e /src/third_party/rl_thor

# Install ProcTHOR from official repo (absolute path)
#RUN git clone https://github.com/allenai/procthor.git /procthor \
 #&& pip install --no-cache-dir -e /procthor


# VNC server entrypoint (must live in docker/ so start_vnc.sh's ROOT=dirname/.. is repo root)
COPY docker/start_vnc.sh /src/docker/start_vnc.sh
RUN sed -i 's/\r$//' /src/docker/start_vnc.sh \
 && chmod +x /src/docker/start_vnc.sh

EXPOSE 5900 6080
CMD ["bash", "-lc", "/src/docker/start_vnc.sh"]